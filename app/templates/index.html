{% extends "base.html" %}
{% block title %}RAG Chatbot{% endblock %}

{% block content %}
<section class="grid">
  <div class="col chat-col card">
    <div class="robot-stage">
      <div id="robot" class="robot">
        <div class="antenna"><span class="tip"></span></div>
        <div class="head">
          <div class="eyes">
            <span class="eye left"><i></i></span>
            <span class="eye right"><i></i></span>
          </div>
          <div class="mouth"></div>
        </div>
        <div class="body"><div class="panel"></div></div>
      </div>
    </div>

    <div id="messages" class="messages" aria-live="polite"></div>

    <form id="chat-form" class="chat-form" autocomplete="off">
      <input id="chat-input" type="text" placeholder="Ask me anythingâ€¦" required />
      <div class="controls">
        <label class="k-label">
          Top-K
          <input id="topk" type="number" min="1" max="10" value="4">
        </label>
        <button id="send-btn" type="submit">Send</button>
      </div>
    </form>
  </div>

  <div class="col docs-col">
    <section class="card">
      <h2>Documents</h2>
      <form id="upload-form" enctype="multipart/form-data" class="upload-form">
        <input type="file" name="files" id="files" accept=".txt" multiple>
        <button type="submit" class="secondary">Upload</button>
      </form>
      <div id="status" class="muted small">Idle</div>
    </section>
  </div>
</section>

<script>
const msgs  = document.getElementById("messages");
const robot = document.getElementById("robot");
const input = document.getElementById("chat-input");
const form  = document.getElementById("chat-form");
const sendBtn = document.getElementById("send-btn");
const topKEl  = document.getElementById("topk");
const statusEl = document.getElementById("status");

function addBubble(text, who="user") {
  const wrap = document.createElement("div");
  wrap.className = `bubble ${who}`;
  wrap.textContent = text;
  msgs.appendChild(wrap);
  msgs.scrollTop = msgs.scrollHeight;
  return wrap;
}

function setThinking(on) {
  robot.classList.toggle("thinking", on);
  sendBtn.disabled = on;
}

async function pollIngestion(jobId) {
  const interval = setInterval(async () => {
    const res = await fetch(`/ingestion-status?jobId=${jobId}`);
    const data = await res.json();
    statusEl.textContent = `Sync status: ${data.status}`;
    if (data.status === "COMPLETE" || data.status === "FAILED") {
      clearInterval(interval);
    }
  }, 3000);
}

document.getElementById("upload-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const fd = new FormData(e.target);
  const res = await fetch("/upload", { method: "POST", body: fd });
  const data = await res.json();

  if (data.error) {
    statusEl.textContent = `Error: ${data.error}`;
  } else {
    statusEl.textContent = "Upload completed. Sync started...";
    if (data.jobId) {
      pollIngestion(data.jobId);
    }
  }
});

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const question = input.value.trim();
  if (!question) return;

  const k = parseInt(topKEl.value || "4", 10);

  addBubble(question, "user");
  input.value = "";

  const botBubble = addBubble("Thinking...", "bot");
  setThinking(true);

  try {
    const res = await fetch("/ask", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ question, k })
    });
    const data = await res.json();
    botBubble.textContent = data.answer || "No answer";
  } finally {
    setThinking(false);
  }
});
</script>
{% endblock %}

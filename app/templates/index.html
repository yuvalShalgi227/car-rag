{% extends "base.html" %}
{% block content %}

<section class="card">
  <h2>Upload Documents</h2>

  <label>Select S3 Folder</label>
  <select id="folderSelect"></select>

  <label>Choose .txt files</label>
  <input type="file" id="files" multiple accept=".txt">

  <button onclick="upload()" class="btn">Upload</button>

  <div id="uploadStatus" style="margin-top:10px; font-size:14px;"></div>
</section>

<section class="card">
  <h2>Ask the Knowledge Base</h2>
  <input id="q" placeholder="Enter your question" class="input">
  <button onclick="ask()" class="btn">Ask</button>

  <pre id="answer" class="answer"></pre>
</section>

<script>
  // Load folders
  async function loadFolders() {
    try {
      const res = await fetch("/folders");
      const data = await res.json();

      const sel = document.getElementById("folderSelect");
      sel.innerHTML = "";

      const indented = data.folders.map(path => {
        const depth = path.split("/").length - 1;
        const prefix = "- ".repeat(depth);
        return { value: path, label: prefix + path };
      });

      indented.forEach(item => {
        const opt = document.createElement("option");
        opt.value = item.value;
        opt.textContent = item.label;
        sel.appendChild(opt);
      });
    } catch (err) {
      console.error("Error loading folders:", err);
    }
  }

  // Upload files
  async function upload() {
    const folder = document.getElementById("folderSelect").value;
    const files = document.getElementById("files").files;
    const statusEl = document.getElementById("uploadStatus");

    if (!folder) {
      statusEl.innerHTML = `<span style="color:red">Please select folder</span>`;
      return;
    }

    if (files.length === 0) {
      statusEl.innerHTML = `<span style="color:red">Please choose files</span>`;
      return;
    }

    // Show "loading..."
    statusEl.innerHTML = `<span style="color:blue">Uploading...</span>`;

    const fd = new FormData();
    fd.append("folder", folder);

    for (const f of files) {
      fd.append("files", f);
    }

    try {
      const res = await fetch("/upload", {
        method: "POST",
        body: fd
      });

      if (!res.ok) {
        throw new Error("Upload failed");
      }

      statusEl.innerHTML = `<span style="color:green">Upload complete</span>`;
      loadFolders();

    } catch (err) {
      statusEl.innerHTML = `<span style="color:red">Upload failed</span>`;
      console.error("Upload failed:", err);
    }
  }

  // Ask KB
  async function ask() {
    const q = document.getElementById("q").value;

    const res = await fetch("/ask", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ question: q })
    });

    const data = await res.json();
    document.getElementById("answer").innerText = data.answer;
  }

  // Init
  loadFolders();
</script>

{% endblock %}
